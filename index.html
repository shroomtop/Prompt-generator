<!DOCTYPE html>
<!--
Magic — Ultimate Universal Prompt Generator (Single-File, Offline, Secure)
Author: Shroomtop420® (Alex)  •  License: MIT
Version: 2.0.0 • Build: 2025-08-28
Source basis: user's Magic prototype (enhanced end-to-end)
Notes:
- Single HTML file, mobile-first, Tailwind CDN, strict CSP, no external images.
- PWA-lite SW for offline caching. No secrets, no telemetry by default.
- Implements canonical slot schema + pattern library + deterministic assembly + validators.
- Every text field has a paired dropdown (quick-pick). Global Library modal adds bulk options.
-->
<html lang="en" class="bg-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Magic — Ultimate Prompt Generator • Shroomtop420®</title>
  <meta name="description" content="Turn any intent into a validated, safe, high-quality ChatGPT prompt. Single-file, offline, secure-by-default."/>
  <meta name="theme-color" content="#0b0c10"/>
  <!-- Strict CSP (nonce must match inline <script> tags); Tailwind CDN allowed -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'none';
    script-src 'nonce-s420nonce' https://cdn.tailwindcss.com;
    style-src 'unsafe-inline';
    img-src 'self' data:;
    connect-src 'self';
    font-src 'none';
    media-src 'none';
    object-src 'none';
    base-uri 'none';
    frame-ancestors 'none';
    form-action 'self';
    manifest-src 'self' data:;
  ">
  <!-- Favicon (inline SVG) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230f1220'/%3E%3Cpath d='M10 42c4 6 12 10 22 10 10 0 18-4 22-10-3-8-11-14-22-14S13 34 10 42z' fill='%2316f5b4'/%3E%3Ccircle cx='32' cy='28' r='6' fill='%23a78bfa'/%3E%3C/svg%3E"/>
  <!-- Manifest (inline data:) -->
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Magic Prompt Generator&quot;,&quot;short_name&quot;:&quot;Magic&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230b0c10&quot;,&quot;theme_color&quot;:&quot;%230b0c10&quot;,&quot;icons&quot;:[]}"/>

  <!-- Tailwind CDN -->
  <script nonce="s420nonce" src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#151822; --line:#23283a; --accent:#16f5b4; --accent2:#a78bfa;
    }
    html,body{height:100%;}
    body{background:
      radial-gradient(1200px 600px at 10% -10%, #0f1220 30%, #0b0c10 60%) no-repeat, #0b0c10;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .glass{ background: rgba(36,39,47,0.68); border-radius:1.2rem; box-shadow: 0 12px 48px #0006; border: 1px solid #21222d66;}
    ::selection{ background:#16f5b4cc; color:#0b0c10;}
    .code{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
    .hr{ height:1px; background:linear-gradient(90deg,transparent,#2d3247,transparent); }
    .btn{ border:1px solid #2a2f43; }
    .btn:hover{ border-color:#3b4160; }
    .select{ background:#0f1220; border:1px solid #2a2f43; border-radius:.75rem; padding:.55rem; }
    .input{ background:#0f1220; border:1px solid #2a2f43; border-radius:.75rem; padding:.55rem .75rem; }
    .chip{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid #2a2f43; border-radius:999px; padding:.15rem .6rem; margin:.15rem; background:#0f1220; }
    .modal{ position:fixed; inset:0; display:none; background:#000a; z-index:50; }
    .modal.open{ display:block; }
    .panel{ position:absolute; inset:0; display:grid; grid-template-columns:280px 1fr; }
    .tabbtn{ display:flex; align-items:center; gap:.5rem; width:100%; text-align:left; padding:.6rem .8rem; border-left:3px solid transparent; border-bottom:1px solid #1e2232; }
    .tabbtn.active{ border-left-color:#16f5b4; background:#0f1220; }
    .listbox{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.5rem; align-content:start; }
    .lb-item{ border:1px solid #2a2f43; border-radius:.75rem; background:#0f1220; padding:.5rem; }
    .ok{ color:#16f5b4; }
    .warn{ color:#fbbf24; }
    .err{ color:#f87171; }
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 pt-8">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <svg aria-hidden="true" width="32" height="32" viewBox="0 0 64 64" class="drop-shadow">
          <rect width="64" height="64" rx="14" fill="#0f1220" stroke="#1f2333" />
          <path d="M10 42c4 6 12 10 22 10 10 0 18-4 22-10-3-8-11-14-22-14S13 34 10 42z" fill="#16f5b4"/>
          <circle cx="32" cy="28" r="6" fill="#a78bfa"/>
        </svg>
        <div>
          <p class="text-xs tracking-wider text-slate-400 uppercase">Shroomtop420®</p>
          <h1 class="text-2xl md:text-3xl font-bold">Magic — Ultimate Prompt Generator</h1>
          <p class="text-slate-300 text-sm">Pick, don’t type. Every slot has quick-picks + library. Deterministic assembly + safety validators.</p>
        </div>
      </div>
      <div class="text-right">
        <p id="status" class="text-xs text-slate-400">Initializing…</p>
        <p class="text-[10px] text-slate-500 code">v2.0.0 • Single-file • Offline</p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-28">
    <!-- Quick Build mirrors original, now upgraded -->
    <section class="mt-6 grid lg:grid-cols-2 gap-4">
      <!-- Builder -->
      <article class="glass p-4 md:p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">1) Build</h2>
          <div class="flex gap-2">
            <button id="openLibrary" class="btn px-3 py-2 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-300">Library (∞)</button>
            <button id="loadHash" class="btn px-3 py-2 rounded-xl bg-sky-500/10 hover:bg-sky-500/20 text-sky-300">Load URL</button>
          </div>
        </div>

        <form id="form" class="mt-3 grid gap-3" autocomplete="off">
          <!-- Domain + Pattern -->
          <div class="grid md:grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Domain</span>
              <select id="domainSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Pattern (router suggests)</span>
              <select id="patternSel" class="select w-full mt-1" multiple></select>
              <p class="text-[11px] text-slate-500 mt-1">Tip: select 1–2 max. Router adds others if needed.</p>
            </label>
          </div>

          <!-- Role -->
          <div class="grid md:grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Role (pick)</span>
              <select id="roleSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Role (freeform)</span>
              <input id="role" class="input w-full mt-1" placeholder="e.g., Senior Editor"/>
            </label>
          </div>

          <!-- Task -->
          <div class="grid md:grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Task template</span>
              <select id="taskSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Task (freeform)</span>
              <input id="task" class="input w-full mt-1" placeholder="What must be done?"/>
            </label>
          </div>

          <!-- Audience + Style/Tone -->
          <div class="grid md:grid-cols-3 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Audience</span>
              <select id="audSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Style</span>
              <select id="styleSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Tone</span>
              <select id="toneSel" class="select w-full mt-1"></select>
            </label>
          </div>

          <!-- Inputs/Context -->
          <div class="grid md:grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Inputs/Context (select)</span>
              <select id="inputsSel" class="select w-full mt-1" multiple></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Inputs/Context (text)</span>
              <textarea id="inputs" rows="3" class="input w-full mt-1"></textarea>
            </label>
          </div>

          <!-- Constraints -->
          <div class="grid md:grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Constraints (select)</span>
              <select id="consSel" class="select w-full mt-1" multiple></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Constraints (text)</span>
              <textarea id="constraints" rows="3" class="input w-full mt-1"></textarea>
            </label>
          </div>

          <!-- Output Format + Verification + Next Action -->
          <div class="grid md:grid-cols-3 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Output format</span>
              <select id="formatSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Verification</span>
              <select id="verifySel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Next Action</span>
              <select id="nextSel" class="select w-full mt-1"></select>
            </label>
          </div>

          <!-- Safety, Locale, Reading level -->
          <div class="grid md:grid-cols-3 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Safety level</span>
              <select id="safetySel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Locale</span>
              <select id="localeSel" class="select w-full mt-1"></select>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Reading level</span>
              <select id="readSel" class="select w-full mt-1"></select>
            </label>
          </div>

          <!-- Length + Seed -->
          <div class="grid md:grid-cols-3 gap-3">
            <label class="block text-sm">
              <span class="text-slate-300">Length limit (chars)</span>
              <input id="len" type="number" min="100" max="20000" value="1200" class="input w-full mt-1 code"/>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Seed</span>
              <input id="seed" type="number" value="1337" class="input w-full mt-1 code"/>
            </label>
            <label class="block text-sm">
              <span class="text-slate-300">Branding (Shroomtop420®)</span>
              <select id="brandSel" class="select w-full mt-1">
                <option value="true">Include</option>
                <option value="false">Exclude</option>
              </select>
            </label>
          </div>

          <!-- Actions -->
          <div class="hr my-2"></div>
          <div class="flex flex-wrap gap-2">
            <button id="assemble" type="button" class="btn px-4 py-2 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-300 font-medium">Assemble Prompt</button>
            <button id="validate" type="button" class="btn px-4 py-2 rounded-xl bg-sky-500/10 hover:bg-sky-500/20 text-sky-300">Validate</button>
            <button id="copyPrompt" type="button" class="btn px-4 py-2 rounded-xl bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-300">Copy Prompt</button>
            <button id="copyJSON" type="button" class="btn px-4 py-2 rounded-xl bg-fuchsia-500/10 hover:bg-fuchsia-500/20 text-fuchsia-300">Copy JSON</button>
            <button id="downloadJSON" type="button" class="btn px-4 py-2 rounded-xl bg-amber-500/10 hover:bg-amber-500/20 text-amber-300">Download JSON</button>
            <button id="shareURL" type="button" class="btn px-4 py-2 rounded-xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-300">Share URL</button>
            <label class="btn px-3 py-2 rounded-xl bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-300 cursor-pointer">
              Import JSON<input id="importJSON" type="file" accept="application/json" class="hidden">
            </label>
            <button id="reset" type="button" class="btn px-4 py-2 rounded-xl bg-[#182033] text-slate-200">Reset</button>
          </div>
        </form>
      </article>

      <!-- Output -->
      <article class="glass p-4 md:p-6">
        <h2 class="text-lg font-semibold">2) Review & Export</h2>
        <div class="grid gap-3">
          <div class="rounded-xl border border-[#2a2f43] bg-[#0f1220] p-3">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-300">Assembled Prompt</p>
              <span id="meta" class="text-[10px] text-slate-500 code">seed: — • chars: —</span>
            </div>
            <textarea id="promptOut" class="w-full h-64 code text-sm bg-transparent outline-none" readonly placeholder="Prompt will appear here…"></textarea>
          </div>

          <div class="rounded-xl border border-[#2a2f43] bg-[#0f1220] p-3">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-300">Generated JSON (PromptConfig)</p>
              <span class="text-[10px] text-slate-500 code">schema: 2025-06-13.04</span>
            </div>
            <pre id="jsonOut" class="max-h-60 overflow-auto code text-xs text-slate-300"></pre>
          </div>

          <div class="rounded-xl border border-[#2a2f43] p-3">
            <p class="text-sm text-slate-300">Validation</p>
            <ul id="valList" class="text-sm list-disc ml-4"></ul>
          </div>

          <div class="rounded-xl border border-[#2a2f43] p-3">
            <p class="text-sm text-slate-300">Logs</p>
            <pre id="logs" class="max-h-40 overflow-auto text-xs code text-slate-400"></pre>
            <div class="flex gap-2 mt-2">
              <button id="exportLogs" class="btn px-3 py-1.5 rounded-lg bg-[#182033] text-slate-200">Export logs</button>
              <button id="purgeLogs" class="btn px-3 py-1.5 rounded-lg bg-rose-500/10 hover:bg-rose-500/20 text-rose-300">Purge</button>
            </div>
          </div>
        </div>
      </article>
    </section>

    <!-- Docs -->
    <section class="mt-6 grid gap-4">
      <details class="glass p-4 md:p-6">
        <summary class="cursor-pointer text-lg font-semibold">README</summary>
        <div class="prose prose-invert max-w-none">
          <p><strong>Magic</strong> turns any intent into a safe, validated prompt. Use Quick picks, or open the Library to mix thousands of options. Deterministic assembly produces stable output. Export raw prompt or JSON.</p>
          <ul>
            <li>Slots: Role, Task, Inputs/Context, Constraints, Style/Tone, Output Format, Verification, Next Action.</li>
            <li>Patterns: Planner, Coach, Critic, Generator, Summarizer, Explainer, Rubber-Duck, Refactorer, Test-Writer, SQL-Smith, DataFrame Analyst, UX Reviewer, Experiment Designer, Lesson Planner, Policy Drafter, Risk Assessor, Translator, Router.</li>
            <li>Safety: Sensitive domains auto-inject disclaimers (legal/medical/financial). No hidden reasoning is requested.</li>
          </ul>
        </div>
      </details>

      <details class="glass p-4 md:p-6">
        <summary class="cursor-pointer text-lg font-semibold">SECURITY.md (Summary)</summary>
        <ul class="text-sm text-slate-300 list-disc ml-5">
          <li>No secrets in code; offline by default; export is explicit.</li>
          <li>Strict CSP; no external images; single origin only.</li>
          <li>PWA SW caches app shell; no network writes.</li>
          <li>Safety disclaimers; refusal path for unsafe asks.</li>
        </ul>
      </details>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-12 text-slate-500 text-xs flex items-center justify-between">
    <span>© <span id="yr"></span> Shroomtop420® • Neon/Futuristic • Single-File</span>
    <span class="code">CSP strict • Offline SW • No secrets</span>
  </footer>

  <!-- Global Library Modal -->
  <div id="libraryModal" class="modal" aria-hidden="true">
    <div class="panel">
      <aside class="bg-[#0d111b] border-r border-[#202436] overflow-auto">
        <div class="p-3">
          <input id="libSearch" class="select code w-full" placeholder="Search…">
          <label class="block mt-2 text-xs text-slate-400">Insert into:
            <select id="libTarget" class="select mt-1">
              <option value="role">Role</option><option value="task">Task</option><option value="inputs">Inputs</option>
              <option value="constraints">Constraints</option><option value="verification">Verification</option><option value="nextAction">Next Action</option>
            </select>
          </label>
          <button id="libInsert" class="btn mt-2 w-full rounded-lg px-3 py-2 bg-emerald-500/10 text-emerald-300">Insert Selected</button>
          <button id="libClose" class="btn mt-2 w-full rounded-lg px-3 py-2 bg-rose-500/10 text-rose-300">Close</button>
        </div>
        <div id="tabs" class="mt-2"></div>
      </aside>
      <section class="bg-[#0b0e17] p-4 overflow-auto">
        <div id="tabTitle" class="text-sm text-slate-300 mb-2">Options</div>
        <div id="listbox" class="listbox"></div>
      </section>
    </div>
  </div>

  <!-- App Script -->
  <script nonce="s420nonce">
  (()=>{'use strict';
    // ---------- DOM ----------
    const $ = s => document.querySelector(s), byId = id => document.getElementById(id);
    const logEl = byId('logs'), valList = byId('valList'), promptOut = byId('promptOut'), jsonOut = byId('jsonOut'), metaEl = byId('meta');
    byId('yr').textContent = new Date().getFullYear();

    // ---------- Utilities ----------
    const SCHEMA_VERSION = "2025-06-13.04";
    const clamp = (n,min,max)=>Math.min(Math.max(Number(n)||0,min),max);
    const esc = s => String(s||'').replace(/[^\n\r\t -~]/g,'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const tsv = (arr)=>arr.map(x=>`- ${x}`).join('\n');
    function l(msg,data) { const line = JSON.stringify({ts:Date.now(),msg,data}); logEl.textContent += line + "\n"; logEl.scrollTop = logEl.scrollHeight; }

    // ---------- Options (curated, extensible) ----------
    const DOMAINS = ["Writing","Coding","Data Analysis","Math/Reasoning","Education/Tutoring","Research & Citations","Translation/Localization","Creative Ideation","Marketing","Sales/Prospecting","Product/UX","Project Management","Operations/Process","Customer Support","DevOps/Cloud","Data Engineering","Legal (non-advisory)","Medical/Health (non-diagnostic)","Financial (non-advisory)","Career/HR","Resume/Interview","Planning/Travel","Personal Productivity","Misc/Custom"];
    const PATTERNS = ["Router","Planner","Coach","Critic","Generator","Summarizer","Explainer","Rubber-Duck","Refactorer","Test-Writer","SQL-Smith","DataFrame Analyst","UX Reviewer","Experiment Designer","Lesson Planner","Policy Drafter","Risk Assessor","Translator"];
    const ROLES = ["Senior Editor","Refactoring Engineer","Data Analyst","Problem Solver","Tutor","Research Summarizer","Localization Specialist","Copy Generator","Marketing Strategist","Sales Writer","UX Reviewer","Project Planner","SOP Designer","Support Guide","DevOps Planner","Data Engineer","Policy Analyst","Health Explainer","Finance Explainer","Career Coach","Interview Coach","Travel Planner","Productivity Coach","General Assistant","Founder/CEO","Full-Stack Engineer","Prompt Engineer"];
    const AUDIENCES = ["Executives","Developers (Junior)","Developers (Senior)","Designers","Investors","Researchers","Students","Customers","Community","General Public","Regulators","QA Team","Security Review Board"];
    const STYLES = ["Neon/Futuristic","Modern/Minimalist","Formal/Concise","Didactic/Coach","Playful","Academic","Journalistic","Sales","Legalese","Accessible","Custom"];
    const TONES = ["Neutral","Confident","Skeptical","Encouraging","Direct","Cautious","Creative","Authoritative","Friendly"];
    const INPUTS = ["Provided text/data only","Schema with examples","Links (trusted)","Screenshots (described)","Assumptions list","Acceptance criteria"];
    const CONSTRAINTS = ["Be concise (≤ lengthLimit)","No speculation; mark assumptions","Provide citations for factual claims","No external images; SVG only","Single file; CDN allowed","No secrets; refuse unsafe asks","Include acceptance tests","Mobile-first & a11y","JSON-safe if applicable"];
    const FORMATS = ["Markdown","Plaintext","JSON","HTML","CSV","Code"];
    const VERIFY = ["List sources with links","Show assumptions","Add acceptance checks","Provide test cases","Include risk/ethics note","Validate JSON/Markdown"];
    const NEXT = ["Offer 3 title options","Ask up to 2 clarifying questions if critical","Propose next iteration","Generate tests","Summarize key trade-offs"];
    const SAFETY = ["General","Sensitive-Legal","Sensitive-Medical","Sensitive-Financial","Youth"];
    const LOCALES = ["en-US","en-GB","es-ES","fr-FR","de-DE","pt-BR","hi-IN","ar","zh-CN","ja-JP","ko-KR"];
    const READING = ["Child","Teen","Adult-General","Expert"];

    const TASK_TEMPLATES = {
      "Writing":[
        "Write a 600-word explainer on <topic> for <audience>",
        "Draft a press release announcing <product>",
        "Create a 7-part outline with key points and sources"
      ],
      "Coding":[
        "Refactor the given code and add unit tests",
        "Generate a single-file app using <stack>",
        "Write a CLI tool to <goal> with examples"
      ],
      "Data Analysis":[
        "Profile dataset (cols: <cols>) and report anomalies",
        "Design analysis plan with KPIs and charts",
        "Summarize insights with limitations"
      ],
      "Marketing":[
        "Create 5 landing headlines and 3 CTAs",
        "Draft an email sequence for <persona>",
        "Write ad copy variants (<=60 chars)"
      ],
      "Misc/Custom":[
        "Given the goal <goal>, produce an action plan with steps",
        "Summarize the following content with citations",
        "Generate 10 ideas with scoring criteria"
      ]
    };

    // ---------- Populate selects ----------
    function fill(id, items, withEmpty=false){ const el = byId(id); el.innerHTML=''; if(withEmpty){ const o=document.createElement('option'); o.value=''; o.textContent='— choose —'; el.appendChild(o); } items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); }); }
    fill('domainSel', DOMAINS);
    fill('patternSel', PATTERNS);
    fill('roleSel', ROLES, true);
    fill('taskSel', TASK_TEMPLATES["Misc/Custom"], true);
    fill('audSel', AUDIENCES, true);
    fill('styleSel', STYLES);
    fill('toneSel', TONES);
    fill('inputsSel', INPUTS);
    fill('consSel', CONSTRAINTS);
    fill('formatSel', FORMATS);
    fill('verifySel', VERIFY);
    fill('nextSel', NEXT);
    fill('safetySel', SAFETY);
    fill('localeSel', LOCALES);
    fill('readSel', READING);

    // Update task templates when domain changes
    byId('domainSel').addEventListener('change', e=>{
      const d = e.target.value;
      fill('taskSel', (TASK_TEMPLATES[d]||TASK_TEMPLATES["Misc/Custom"]), true);
      // Suggest patterns per domain
      const suggest = {
        "Writing":["Generator","Critic"], "Coding":["Refactorer","Test-Writer"],
        "Data Analysis":["DataFrame Analyst","Explainer"], "Math/Reasoning":["Explainer","Planner"],
        "Education/Tutoring":["Lesson Planner","Coach"], "Research & Citations":["Summarizer","Critic"],
        "Translation/Localization":["Translator","Explainer"], "Creative Ideation":["Generator","Critic"],
        "Marketing":["Planner","Generator"], "Sales/Prospecting":["Generator","Critic"],
        "Product/UX":["UX Reviewer","Planner"], "Project Management":["Planner"],
        "Operations/Process":["Planner","Risk Assessor"], "Customer Support":["Explainer","Policy Drafter"],
        "DevOps/Cloud":["Planner","Risk Assessor"], "Data Engineering":["Planner","Risk Assessor"],
        "Legal (non-advisory)":["Policy Drafter","Critic"], "Medical/Health (non-diagnostic)":["Explainer","Risk Assessor"],
        "Financial (non-advisory)":["Explainer","Risk Assessor"], "Career/HR":["Coach","Critic"],
        "Resume/Interview":["Coach","Critic"], "Planning/Travel":["Planner"],
        "Personal Productivity":["Coach","Planner"], "Misc/Custom":["Router"]
      }[d] || ["Router"];
      const sel = byId('patternSel'); Array.from(sel.options).forEach(o=>o.selected = suggest.includes(o.value));
    });

    // Bind select quick-picks to freeform fields
    function bindSelectToField(selId, fieldId, append=false){
      const sel = byId(selId), fld = byId(fieldId);
      sel.addEventListener('change', ()=>{
        const vals = Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
        if(!append){ fld.value = vals.join(', '); } else {
          const add = sel.multiple ? vals.map(v=>`- ${v}`).join('\n') : vals[0]||'';
          fld.value = fld.value ? (fld.value + '\n' + add) : add;
        }
      });
    }
    bindSelectToField('roleSel','role');
    bindSelectToField('taskSel','task');
    bindSelectToField('audSel','role',true); // audience hints influence role wording if desired
    bindSelectToField('inputsSel','inputs',true);
    bindSelectToField('consSel','constraints',true);
    bindSelectToField('verifySel','constraints',true);
    bindSelectToField('nextSel','constraints',true);

    // ---------- Config helpers ----------
    function selected(id){ return Array.from(byId(id).selectedOptions).map(o=>o.value); }
    function getConfig(){
      const domain = byId('domainSel').value || "Misc/Custom";
      const cfg = {
        schema_version: SCHEMA_VERSION,
        role: esc(byId('role').value || byId('roleSel').value || "Assistant"),
        task: esc(byId('task').value || byId('taskSel').value || "Describe your goal"),
        inputs: esc(byId('inputs').value),
        constraints: esc(byId('constraints').value),
        style: byId('styleSel').value || "Modern/Minimalist",
        tone: byId('toneSel').value || "Neutral",
        outputFormat: byId('formatSel').value || "Markdown",
        verification: selected('verifySel')[0] || "",
        nextAction: selected('nextSel')[0] || "",
        domain,
        pattern: selected('patternSel')[0] || "Router",
        audience: selected('audSel')[0] || "",
        lengthLimit: clamp(byId('len').value, 100, 20000),
        references: [],
        safetyLevel: byId('safetySel').value || (["Legal (non-advisory)","Medical/Health (non-diagnostic)","Financial (non-advisory)"].includes(domain) ? "Sensitive-"+domain.split(' ')[0] : "General"),
        locale: byId('localeSel').value || "en-US",
        readingLevel: byId('readSel').value || "Adult-General",
        seed: clamp(byId('seed').value, 0, 4294967295),
        branding: byId('brandSel').value === "true"
      };
      return cfg;
    }

    // ---------- Assembly ----------
    function disclaimer(safety, domain){
      if(safety==="Sensitive-Legal") return "This is educational information, not legal advice. Consult a qualified attorney.";
      if(safety==="Sensitive-Medical") return "This is educational information, not medical advice. Consult a licensed clinician.";
      if(safety==="Sensitive-Financial") return "This is informational content, not investment advice. Consider professional guidance.";
      if(domain==="Youth") return "Use age-appropriate language and content. Avoid sensitive or harmful material.";
      return "";
    }
    function assemblePrompt(cfg){
      const blocks = [];
      blocks.push(`ROLE: ${cfg.role}`);
      blocks.push(`TASK: ${cfg.task}`);
      if(cfg.audience) blocks.push(`AUDIENCE: ${cfg.audience}`);
      if(cfg.inputs) blocks.push(`INPUTS/CONTEXT:\n${cfg.inputs}`);
      if(cfg.constraints) blocks.push(`CONSTRAINTS:\n${cfg.constraints.split('\n').map(s=>s.startsWith('- ')?s:('- '+s)).join('\n')}`);
      blocks.push(`STYLE/TONE: ${cfg.style} | ${cfg.tone}`);
      blocks.push(`OUTPUT FORMAT: ${cfg.outputFormat}`);
      if(cfg.verification) blocks.push(`VERIFICATION: ${cfg.verification}`);
      if(cfg.nextAction) blocks.push(`NEXT ACTION: ${cfg.nextAction}`);
      blocks.push(`PATTERN: ${cfg.pattern}`);
      blocks.push(`GUIDANCE:\n- Do not reveal hidden reasoning or chain-of-thought.\n- Cite sources for factual claims or state uncertainty.\n- Follow safety policies. Refuse unsafe requests with alternatives.`);
      const disc = disclaimer(cfg.safetyLevel, cfg.domain);
      if(disc) blocks.push(`DISCLAIMER: ${disc}`);
      let prompt = blocks.join('\n\n');
      if(prompt.length > cfg.lengthLimit) prompt = prompt.slice(0, cfg.lengthLimit);
      return prompt;
    }

    // ---------- Validation ----------
    function validateCfg(cfg){
      const errs=[], warns=[];
      if(!cfg.role || cfg.role.length<3) errs.push("Role is required (≥3 chars).");
      if(!cfg.task || cfg.task.length<5) errs.push("Task is required (≥5 chars).");
      if(!cfg.outputFormat) errs.push("Output format is required.");
      // Domain-specific safety
      if(["Legal (non-advisory)","Medical/Health (non-diagnostic)","Financial (non-advisory)"].includes(cfg.domain)){
        if(!cfg.safetyLevel.startsWith("Sensitive")) warns.push("Sensitive domain detected; safety disclaimer will be injected.");
      }
      // Length bounds
      if(cfg.lengthLimit<100 || cfg.lengthLimit>20000) errs.push("lengthLimit out of bounds.");
      // Formatting expectations
      if(cfg.outputFormat==="JSON"){
        if(!/json/i.test(cfg.constraints+cfg.verification+cfg.task)) warns.push("Output is JSON but no JSON-specific instruction found.");
      }
      return {ok: errs.length===0, errors:errs, warnings:warns};
    }

    // ---------- Renderers ----------
    function renderValidation(res){
      valList.innerHTML='';
      if(res.errors.length===0 && res.warnings.length===0){
        const li=document.createElement('li'); li.innerHTML = `<span class="ok">✓ All checks passed.</span>`; valList.appendChild(li); return;
      }
      res.errors.forEach(e=>{ const li=document.createElement('li'); li.innerHTML = `<span class="err">✖ ${esc(e)}</span>`; valList.appendChild(li); });
      res.warnings.forEach(w=>{ const li=document.createElement('li'); li.innerHTML = `<span class="warn">⚠ ${esc(w)}</span>`; valList.appendChild(li); });
    }
    function renderJSON(cfg){
      const out = {
        schema_version: cfg.schema_version,
        project_type: "Web Tool/App",              // legacy compatibility field
        topic: cfg.task.slice(0,90),
        style: cfg.style,
        stack: "HTML5 + Tailwind CSS + ES6 JS",    // default stack; adjust in constraints if needed
        format: cfg.outputFormat==="Code" ? "Plain code (no block)" : "Single HTML file",
        features: [],
        special_requests: [],
        branding: cfg.branding,
        rules: [
          "Output a single, self-contained file (unless ZIP is selected)",
          "All CSS/JS must be inline or via CDN",
          "Use semantic, accessible HTML and responsive layout",
          "No external image dependencies (SVG/CSS/HTML only)",
          "Match this structure: [headline/subheadline][main diagram/feature][clean, centered, visually balanced]",
          "Do not reveal hidden reasoning; provide final answers only"
        ],
        end_instruction: "Ready to copy-paste and run.",
        // Canonical config (authoritative)
        config: {
          role: cfg.role, task: cfg.task, inputs: cfg.inputs, constraints: cfg.constraints,
          style: cfg.style, tone: cfg.tone, outputFormat: cfg.outputFormat,
          verification: cfg.verification, nextAction: cfg.nextAction,
          domain: cfg.domain, pattern: cfg.pattern, audience: cfg.audience,
          lengthLimit: cfg.lengthLimit, references: cfg.references,
          safetyLevel: cfg.safetyLevel, locale: cfg.locale, readingLevel: cfg.readingLevel, seed: cfg.seed
        }
      };
      jsonOut.textContent = JSON.stringify(out, null, 2);
    }

    // ---------- Actions ----------
    function assembleAndRender(){
      const cfg = getConfig();
      const val = validateCfg(cfg); renderValidation(val);
      const prompt = assemblePrompt(cfg);
      promptOut.value = prompt;
      metaEl.textContent = `seed: ${cfg.seed} • chars: ${prompt.length}`;
      renderJSON(cfg);
      l('assemble', {domain:cfg.domain, pattern:cfg.pattern, len:prompt.length});
    }

    byId('assemble').addEventListener('click', assembleAndRender);
    byId('validate').addEventListener('click', ()=>{
      const cfg=getConfig(); const val=validateCfg(cfg); renderValidation(val); renderJSON(cfg);
      l('validate', {ok:val.ok, errors:val.errors.length, warnings:val.warnings.length});
    });

    byId('copyPrompt').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(promptOut.value||''); l('copyPrompt'); }catch{}
    });
    byId('copyJSON').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(jsonOut.textContent||''); l('copyJSON'); }catch{}
    });
    byId('downloadJSON').addEventListener('click', ()=>{
      const blob = new Blob([jsonOut.textContent], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='prompt_config.json'; a.click();
      l('downloadJSON');
    });
    byId('shareURL').addEventListener('click', ()=>{
      const cfg = getConfig();
      const s = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(cfg)))));
      const url = location.origin + location.pathname + '#cfg=' + s;
      navigator.clipboard.writeText(url).catch(()=>{});
      l('shareURL');
      alert('Sharable URL copied to clipboard.');
    });
    byId('importJSON').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const txt=await f.text(); try{ const j=JSON.parse(txt); applyConfig(j.config || j); assembleAndRender(); }catch(ex){ alert('Invalid JSON'); }
    });
    byId('reset').addEventListener('click', ()=> location.reload());

    // ---------- Load from URL hash ----------
    function loadHash(){
      const h = location.hash.slice(1);
      const m = /^cfg=(.+)$/.exec(h);
      if(!m) return;
      try{
        const json = decodeURIComponent(escape(atob(decodeURIComponent(m[1]))));
        const cfg = JSON.parse(json);
        applyConfig(cfg); assembleAndRender();
      }catch{ /* ignore */ }
    }
    function applyConfig(cfg){
      const setSel=(id,val)=>{ const el=byId(id); if(!el) return; Array.from(el.options).forEach(o=>o.selected = (el.multiple ? (val||[]).includes(o.value) : o.value===val)); if(!el.multiple) el.value = val||el.value; el.dispatchEvent(new Event('change')); };
      setSel('domainSel', cfg.domain);
      setSel('patternSel', [cfg.pattern]);
      byId('role').value = cfg.role||'';
      byId('task').value = cfg.task||'';
      byId('inputs').value = cfg.inputs||'';
      byId('constraints').value = cfg.constraints||'';
      setSel('styleSel', cfg.style);
      setSel('toneSel', cfg.tone);
      setSel('audSel', [cfg.audience]);
      setSel('formatSel', cfg.outputFormat);
      setSel('verifySel', [cfg.verification]);
      setSel('nextSel', [cfg.nextAction]);
      setSel('safetySel', cfg.safetyLevel);
      setSel('localeSel', cfg.locale);
      setSel('readSel', cfg.readingLevel);
      byId('len').value = cfg.lengthLimit||1200;
      byId('seed').value = cfg.seed||1337;
      byId('brandSel').value = String(!!cfg.branding);
    }
    byId('loadHash').addEventListener('click', loadHash);
    window.addEventListener('DOMContentLoaded', loadHash);

    // ---------- Logs export/purge ----------
    byId('exportLogs').addEventListener('click', ()=>{
      const blob = new Blob([logEl.textContent], {type:'text/plain'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='logs.jsonl'; a.click();
    });
    byId('purgeLogs').addEventListener('click', ()=>{ logEl.textContent=''; l('logs.purge'); });

    // ---------- Library Modal ----------
    const modal = byId('libraryModal'), listbox = byId('listbox'), libSearch = byId('libSearch'), tabsEl = byId('tabs'), tabTitle = byId('tabTitle');
    const LIB_TABS = [
      {id:'roles',label:'Roles',data:ROLES},
      {id:'tasks',label:'Tasks',data:[...new Set(Object.values(TASK_TEMPLATES).flat())]},
      {id:'inputs',label:'Inputs',data:INPUTS},
      {id:'constraints',label:'Constraints',data:CONSTRAINTS},
      {id:'verify',label:'Verification',data:VERIFY},
      {id:'next',label:'Next Actions',data:NEXT}
    ];
    let activeTab = 'roles';
    function openLib(){ modal.classList.add('open'); renderTabs(); renderList(); libSearch.value=''; }
    function closeLib(){ modal.classList.remove('open'); }
    byId('openLibrary').onclick=openLib; byId('libClose').onclick=closeLib;

    function renderTabs(){
      tabsEl.innerHTML='';
      LIB_TABS.forEach(t=>{
        const b=document.createElement('button'); b.className='tabbtn text-slate-300'; b.textContent=t.label;
        if(t.id===activeTab) b.classList.add('active');
        b.onclick=()=>{ activeTab=t.id; renderTabs(); renderList(); };
        tabsEl.appendChild(b);
      });
    }
    function renderList(){
      listbox.innerHTML='';
      const data = LIB_TABS.find(t=>t.id===activeTab).data;
      tabTitle.textContent = `${LIB_TABS.find(t=>t.id===activeTab).label} — ${data.length} options`;
      const q = libSearch.value.trim().toLowerCase();
      data.filter(v=>!q || v.toLowerCase().includes(q)).forEach(v=>{
        const d=document.createElement('label'); d.className='lb-item text-slate-300';
        d.innerHTML = `<input type="checkbox" class="mr-2"> <span>${v}</span>`;
        listbox.appendChild(d);
      });
    }
    libSearch.addEventListener('input', renderList);
    byId('libInsert').onclick=()=>{
      const target = byId('libTarget').value;
      const picks = Array.from(listbox.querySelectorAll('input:checked')).map(c=>c.nextElementSibling.textContent);
      if(!picks.length) return;
      const field = byId(target);
      const isTextArea = field.tagName==='TEXTAREA';
      const addition = picks.map(x=> activeTab==='constraints' || activeTab==='inputs' ? `- ${x}` : x).join(isTextArea?'\n':', ');
      field.value = field.value ? (isTextArea? field.value+'\n'+addition : field.value+', '+addition) : addition;
      closeLib();
    };

    // ---------- PWA-lite Service Worker ----------
    (async function registerSW(){
      if(!('serviceWorker' in navigator)) { byId('status').textContent='No SW'; return; }
      const swCode = `
        const CACHE='magic-v2';
        self.addEventListener('install', e=>{ e.waitUntil((async()=>{ const c=await caches.open(CACHE); await c.addAll(['./']); self.skipWaiting(); })()); });
        self.addEventListener('activate', e=> e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', e=>{ e.respondWith((async()=>{ const c=await caches.open(CACHE); const r=await c.match(e.request); return r || fetch(e.request).then(res=>{ if(e.request.method==='GET' && res.ok) c.put(e.request,res.clone()); return res; }); })()); });
      `;
      const url = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
      try{
        await navigator.serviceWorker.register(url,{scope:'./'});
        byId('status').textContent='Offline-ready • SW active';
      }catch{ byId('status').textContent='SW error'; }
    })();

    // ---------- Init ----------
    // Prefill sensible defaults aligned with original prototype
    byId('domainSel').value = "Misc/Custom"; byId('domainSel').dispatchEvent(new Event('change'));
    byId('styleSel').value = "Neon/Futuristic";
    byId('formatSel').value = "Markdown";
    byId('safetySel').value = "General";
    l('app.start',{ua:navigator.userAgent});
  })();
  </script>
</body>
</html>
